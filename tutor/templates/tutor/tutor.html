{% extends "core/base.html" %}
{% load static compress mathfilters %}

{% block css %}
    {% compress css %}
        <link rel="stylesheet" type="text/x-scss" href="{% static 'css/pages/lesson.scss' %}" media="screen">
    {% endcompress %}
{% endblock %}

{% block body_js %}
    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" 
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" 
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- ACE Editor Library -->
    {% include "core/partial/_ace_lib.html" %}

    <!-- Custom Think-Aloud Library -->
    {% include "core/partial/_think_aloud.html" %}

    <script type="application/javascript">
        $(document).ready(function () {
            //this will be done in a load lesson function call
            createEditor("{{ lesson_code | safe }}", "{{ lesson.reason.reasoning_type | safe }}", "{{ lesson.lesson_title | safe }}", "{{ review | safe }}", "{{ past | safe }}", false);
            $("#tutor").attr("class", "nav-item active");
            $("#navbarColor").attr("class", "navbar navbar-expand-lg navbar-dark bg-dark");

            // session recording and transcribing
            initThinkAloudFunctions("{{ audio_record }}" === 'True', "{{ screen_record }}" === 'True', "{{ audio_transcribe }}" === 'True',
                "{{ user_email }}", "{{ index }}", "{{ lesson.lesson_title }}");

            // enable tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
        });
        const assignment = {{ assignment.id }};
    </script>
{% endblock %}

{% block main_content %}
    <div class="container-fluid" id="main">
        <div class="row">
            <!-- Column 1: Tutorial Contents -->
            <div class="col-3 p-0" id="sidebar">
                <div class="d-flex flex-column" id="tutorialCol">
                    <!-- Tutorial Content -->
                    <div class="container-fluid jumbotron mb-0 py-4">
                        <div class="container text-center">
                            <h1 id="lessonName">{{lesson.lesson_title}}</h1>
                        </div>
                    </div>
                    <div class="container p-3" id="tutorialContent">
                        <div class="page-section-heading mb-3">
                            <h3>Activity Description</h3>
                        </div>
                        <div class="my-4">
                            {{ lesson.instruction|safe }}
                        </div>
                        <span id="answersCard" hidden>
                            <div class="page-section-heading mb-3">
                                <h3>Past Answers</h3>
                            </div>
                            <div class="card bg-danger my-4">
                                <div class="card-body">
                                    <span id="pastAnswers"></span>
                                </div>
                            </div>
                        </span>
                        {% if referenceSet %}
                        <div class="page-section-heading mb-3">
                            <h3>Reference Material</h3>
                        </div>
                        <div class="card bg-light my-4">
                            <div class="card-body">
                                <span id="referenceMaterial">
                                {% for obj in referenceSet %}
                                    <p>{{ obj | safe }}</p>
                                {% endfor %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        {% if concept %}
                        <div class="page-section-heading mb-3">
                            <h3>Concepts</h3>
                        </div>
                        <div class="d-flex flex-wrap align-items-center justify-content-around">
                        {% for obj in concept %}
                            <span class="badge rounded-pill bg-info">
                                {{ obj | safe }}
                            </span>
                        {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- OffCanvas: View Lessons -->
            <div class="offcanvas offcanvas-start" id="offcanvasViewLessons">
                <div class="offcanvas-header border-bottom">
                    <h5 class="offcanvas-title text-black" id="offcanvasViewLessonsLabel">View Lessons</h5>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ol class="list-group list-group-flush list-group-numbered">
                    {% for obj in orderedSet%}
                        {% if forloop.counter0 == index and not obj.is_alternate%}
                            <li class="list-group-item text-white fs-5 fw-bold">{{ obj | safe }}</li>
                        {% elif not obj.is_alternate %}
                            {% if forloop.counter0 < index %}
                            <li class="list-group-item text-black fs-5">{{ obj | safe }}</li>
                            {% elif forloop.counter0 == completedLessonNum %}
                            <li class="list-group-item text-black fs-5"><a href="{% url 'tutor:tutor' assignmentID=assignment.id %}">{{ obj | safe }}</a></li>
                            {% else %}
                            <li class="list-group-item text-black fs-5">{{ obj | safe }}</li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    </ol>
                </div>
            </div>

            <!-- Column 2: Editor Contents -->
            <div class="col-6 p-0" id="content">
                <div id="editorCol" class="d-flex flex-column h-100">
                    <!-- Ace Editor -->
                    <div id="editor" class="flex-grow-1 p-0"></div>

                    <!-- Error Card -->
                    <div id="compilerResult"></div>

                    <!-- Editor Toolbar -->
                    <div id="editorToolbar" class="p-2 text-white">
                        <div class="btn-toolbar font-weight-light" role="toolbar" aria-label="Editor Toolbar">
                            <!-- Font-Related Buttons -->
                            <div id="fontButtons" class="d-inline-flex border border-white p-1">
                                <span class="d-none d-md-block my-auto me-2">Font:</span>
                                <button id="fontIncrease" class="btn btn-sm btn-light me-1" type="button">
                                    <i class="fas fa-plus fa-fw" aria-hidden="true" title="+"></i>
                                </button>
                                <button id="fontDecrease" class="btn btn-sm btn-light me-2" type="button">
                                    <i class="fas fa-minus fa-fw" aria-hidden="true" title="-"></i>
                                </button>
                                <button class="btn btn-sm btn-light" id="changeMode" type="button" title="Change Mode" data-toggle="tooltip" data-placement="top" title="Change theme">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-brightness-high-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 8a4 4 0 1 1-8 0 4 4 0 0 1 8 0z"/>
                                        <path fill-rule="evenodd"
                                              d="M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                                    </svg>
                                    Light
                                </button>
                            </div>
                            <!-- Compiler-Related Buttons -->
                            <div id="compilerButtons" class="ms-auto">
                                <!-- AreYouSure Modal -->
                                <div class="modal fade" id="areYouSure" tabindex="-1" role="dialog" aria-labelledby="areYouSureModalLabel" aria-hidden="true" style="transform: translate(0, 25%);">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-secondary text-dark-50 bg-opacity-25">
                                                <h5 class="modal-title text-dark">Reset Code</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body w-100 text-center">
                                                <span class="text-dark fs-5 fw-bold">Are you sure you want to reset back to the default code template? You will lose your current code.</span>
                                            </div>
                                            <div class="modal-footer">
                                                <button id="resetCode" class="btn btn-danger btn-inline" type="button" data-toggle="tooltip" data-placement="top" title="Reset">Reset</button>
                                                <button type="button" class="btn btn-outline-secondary btn-inline" data-bs-dismiss="modal">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-light" type="button"  data-bs-toggle="offcanvas" id="toggleOffCanvas" data-bs-target="#offcanvasViewLessons" aria-expanded="false" aria-controls="offcanvasViewLessons">
                                    <i class="fa fa-list" aria-hidden="true"></i> View Lessons
                                </button>
                                <button id="giveHint" class="btn btn-light" type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Get Help">
                                    <i class="far fa-life-ring"></i>
                                </button>
                                <button type="button" class="btn btn-danger" title="Reset" data-bs-toggle="modal" data-bs-target="#areYouSure">
                                    <i class="fa">&#xf021;</i>
                                </button>
                                <button id="checkCorrectness" class="btn btn-success" type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Check Correctness">
                                    <i class="fas fa-clipboard-check"></i>
                                    Verify
                                    <div id="getIndex"></div>
                                    <div id="csrf">{% csrf_token %}</div>
                                </button>
                            </div>
                        </div>
                        <!-- Direction-Related Buttons -->
                        <div id="directionButtons" class="d-flex">
                            <div id="stepProgressBar">
                                <div class="step">
                                    {% if index <= 1 %}
                                    <div class="bullet completed">-</div>
                                    {% else %}
                                    <div class="bullet completed">{{ index|sub:1 }}</div>
                                    {% endif %}
                                </div>
                                <div class="step">
                                    {% if index == 0 %}
                                    <div class="bullet completed">-</div>
                                    {% else %}
                                    <div data-bs-toggle="tooltip" data-bs-placement="top" title="The last lesson you completed" class="bullet completed">{{index}}</div>
                                    {% endif %}
                                </div>
                                <div class="step">
                                    <div data-bs-toggle="tooltip" data-bs-placement="top" title="The lesson you are currently working on" class="bullet current">{{index|add:1}}</div>
                                </div>
                                <div class="step">
                                    {% if index == setLength or index == setLength|sub:1 %}
                                    <div class="bullet last">-</div>
                                    {% else %}
                                    <div data-bs-toggle="tooltip" data-bs-placement="top" title="The next lesson you will encounter" class="bullet last">{{index|add:2}}</div>
                                    {% endif %}
                                </div>
                                <div class="step">
                                    {% if index|add:2 >= setLength  %}
                                    <div class="bullet end">-</div>
                                    {% else %}
                                    <div class="bullet end" data-bs-toggle="tooltip" data-bs-placement="top" title="The last lesson in the set">{{setLength}}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div tabindex="0" data-bs-toggle="tooltip" data-bs-placement="top" title="Next">
                                <button id="next" type="button" class="btn btn-light btn-md" disabled>Next</button>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress">
                        <div class="progress-bar bg-success" id="percent" role="progressbar" style="width: {{index|div:setLength|mul:100}}%;" aria-valuemin="0" aria-valuemax="100">{{index|div:setLength|mul:100|floatformat }}%</div>
                    </div>
                    <script src="{% static 'javascript/lesson/editorUtils.js' %}"></script>
                </div>
            </div>

            <!-- Column 3: Results Contents -->
            <div class="col-3 resultPanel p-0 bg-dark" id="resultsCol" style="--bs-bg-opacity: .9;"> 
                <div class="d-flex flex-column align-items-end h-100">
                    <div id="resultCard" class="card">
                        <h6 class="card-header text-center" id="resultsHeader"></h6>
                        <div class="card-body">
                            <p class="card-text" id="resultDetails"></p>
                        </div>
                    </div>
                    <div id="explainCard" class="card mt-auto text-dark bg-light">
                        {% if lesson.reason.reasoning_type == 'Text' %}
                        <form id="usrform">
                            <div id="results">
                                <b>{{ reason }}</b>
                            </div>
                            <textarea id="explainBox" rows="4" name="comment" form="usrform"
                                        placeholder="Type answer here..." required></textarea>
                        </form>
                        {% elif lesson.reason.reasoning_type == 'MC' %}
                        <form id="multiform">
                            <div class="form-check">
                                {{reason}}
                                {% for obj in mc_set %}
                                <br>
                                <input class="form-check-input" type="radio" name="selectExplain" value="{{ obj | safe}}">
                                <label class="form-check-label" for="exampleRadios1" id="radio">
                                    {{ obj | safe}}
                                </label>
                                {% endfor %}
                            </div>
                        </form>
                        {% elif lesson.reason.reasoning_type == 'Both' %}
                        <form id="usrform">
                            <div id="results">
                                <b>{{ reason }}</b>
                            </div>
                            <textarea id="explainBox" rows="4" name="comment" form="usrform" placeholder="Type answer here..." required></textarea>
                        </form>
                        <div class="form-check">
                            {{ reason }}
                            {% for obj in mc_set %}
                            <br>
                            <input class="form-check-input" type="radio" name="selectExplain" id="select" value="option">
                            <label class="form-check-label" for="exampleRadios1" id="radio">
                                {{ obj | safe }}
                            </label>
                            {% endfor %}
                        </div>
                        {% elif lesson.reason.reasoning_type == 'None' %}
                        {% endif %}
                        <div id="results">
                            <b>How do you feel about verification now? Click one</b>
                            <a href="#" data-bs-toggle="tooltip" data-bs-placement="top" title="This is to help identify which topics you need more help with!">
                                <i class="fa fa-question-circle" aria-hidden="true"></i>
                            </a>
                        </div>
                        <form id="smileys" style="text-align: center;">
                            {% if mood == "upset" %}
                            <input type="radio" name="smiley" value="upset" class="upset" checked="checked">
                            <input type="radio" name="smiley" value="sad" class="sad">
                            <input type="radio" name="smiley" value="neutral" class="neutral">
                            <input type="radio" name="smiley" value="happy" class="happy">
                            <input type="radio" name="smiley" value="excited" class="excited">
                            {% elif mood == "sad" %}
                            <input type="radio" name="smiley" value="upset" class="upset">
                            <input type="radio" name="smiley" value="sad" class="sad" checked="checked">
                            <input type="radio" name="smiley" value="neutral" class="neutral">
                            <input type="radio" name="smiley" value="happy" class="happy">
                            <input type="radio" name="smiley" value="excited" class="excited">
                            {% elif mood == "neutral" %}
                            <input type="radio" name="smiley" value="upset" class="upset">
                            <input type="radio" name="smiley" value="sad" class="sad">
                            <input type="radio" name="smiley" value="neutral" class="neutral" checked="checked">
                            <input type="radio" name="smiley" value="happy" class="happy">
                            <input type="radio" name="smiley" value="excited" class="excited">
                            {% elif mood == "happy" %}
                            <input type="radio" name="smiley" value="upset" class="upset">
                            <input type="radio" name="smiley" value="sad" class="sad">
                            <input type="radio" name="smiley" value="neutral" class="neutral">
                            <input type="radio" name="smiley" value="happy" class="happy" checked="checked">
                            <input type="radio" name="smiley" value="excited" class="excited">
                            {% elif mood == "excited" %}
                            <input type="radio" name="smiley" value="upset" class="upset">
                            <input type="radio" name="smiley" value="sad" class="sad">
                            <input type="radio" name="smiley" value="neutral" class="neutral">
                            <input type="radio" name="smiley" value="happy" class="happy">
                            <input type="radio" name="smiley" value="excited" class="excited" checked="checked">
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}